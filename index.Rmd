---
title: "Lente Ecologica"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
  runtime: shiny
resource_files:
- map.prj
- map.shx
- map.dbf
- ucstodas.dbf
- ucstodas.shx
---

```{r global, include=FALSE}

library(flexdashboard)
library(tidyverse)
library(plotly)
library(leaflet)
library(plotly)


# load data
occ_NF <- read.csv("GBIF_occ_NF_03may2022.csv", header = T)

NORFLU <- rgdal::readOGR("map.shp")
#UCs <- rgdal::readOGR("ucstodas.shp")

```

# Início

## Introdução {.sidebar}


A "Lente Ecológica" faz um paralelo entre as metodologias utilizadas no projeto e como a sociedade percebe o meio ambiente. O objetivo do projeto é ajustar o 'foco' dos participantes em relação a fauna e flora, e como o ser humano se observa nessas relações. Utilizando a observação direta como meio de inserção dos participantes no contexto ambiental, as lentes das câmeras e *smartphones* e as mídias sociais serão as ferramentas do aprendizado empírico-científico e sensibilização ambiental dos participantes.

***

```{r, out.width=220}

knitr::include_graphics("lente_ecologica.png", error = FALSE)

```


------------------------------------------------------------------------

## Row 1 {data-height="650"}

### **Ocorrências de espécies no Norte Fluminense** - Cada ponto na imagem corresponde a um registro de ocorrência de uma espécie ou táxon na região Norte Fluminense. Os dados foram coletados da base *Global Biodiversity Information Facility* (GBIF).

```{r mapa NF}

pal <- colorFactor(palette = "viridis", domain = unique(occ_NF$kingdom))

NORFLU %>% 
  leaflet() %>% 
  addTiles() %>% 
  addPolygons(col = "",
              fillColor = "orange",
              highlight = highlightOptions(weight = 0.2,
                                           color = "red",
                                           fillOpacity = 0.7,
                                           bringToFront = F),
              label = ~NM_MUNICIP) %>% 
  addCircleMarkers(data = occ_NF,
                   ~decimalLongitude,
                   ~decimalLatitude,
                   radius = 2,
                   #label = ~as.character(datasetName),
                   color = ~pal(occ_NF$kingdom),
                   stroke = FALSE, fillOpacity = 0.5) %>%
  addLegend('bottomright',
          colors = unique(pal(occ_NF$kingdom)),
          labels = unique(occ_NF$kingdom),
          title = 'Dataset',
          opacity = 0.5)

```

## Row 2 {data-height="300"}

### Espécies por Reino {data-width="400"}

```{r}

a2 <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
  filter(kingdom != "incertae sedis") %>% 
  group_by(kingdom) %>% 
  summarise(spp = n_distinct(scientificName)) %>% 
  ggplot(aes(y = kingdom, x = spp, fill = kingdom)) +
    geom_bar(stat = 'identity') +
    theme_classic() +
    theme(legend.position = "") +
    labs(y = "")

ggplotly(a2) %>%
  layout(
    showlegend = F, 
    legend = list(orientation = 'h')
  )

```

### Espécies por Filo e Reino

```{r}

rank <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
  group_by(kingdom, phylum) %>% 
  summarise(spp = n_distinct(scientificName)) %>% 
  filter(!phylum %in% c(NA, "")) %>% 
  arrange(kingdom, spp) %>% 
  pull(phylum)

a1 <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
  group_by(kingdom, phylum) %>% 
  summarise(spp = n_distinct(scientificName)) %>% 
  filter(!phylum %in% c(NA, "")) %>% 
  mutate(phylum = factor(phylum, levels = rank)) %>% 
  ggplot(aes(y = phylum, x = spp, fill = kingdom)) +
    geom_bar(stat = 'identity') +
    theme_classic() +
    theme(legend.position = "") +
    labs(x = "Espécies (n)", y = "")

ggplotly(a1)


```

### Espécies por Reino em cada município

```{r}

rankK <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
  group_by(kingdom) %>% 
  summarise(spp = n_distinct(scientificName)) %>% 
  arrange(kingdom, spp) %>% 
  pull(kingdom)

a3 <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
  filter(kingdom != "incertae sedis",
         !phylum %in% c(NA, "")) %>% 
  mutate(kingdom = factor(kingdom, levels = rankK)) %>%
  select(kingdom, NM_MUNICIP, scientificName) %>% 
  ggplot(aes(y = NM_MUNICIP, fill = kingdom)) +
    geom_bar(position = 'fill') +
    theme_classic() +
    labs(x = "Número de espécies", y = "") +
    theme(legend.title = element_blank())

ggplotly(a3)

```

------------------------------------------------------------------------

# Municípios do Norte Fluminense

## Inputs {.sidebar}

```{r}

lista_NM_MUNICIPs <- occ_NF %>% distinct(NM_MUNICIP) %>% pull()

selectInput("NM_MUNICIPs", label = h3("Selecione um município para ver as ocorrências de espécies locais"), 
            choices = lista_NM_MUNICIPs, 
            selected = lista_NM_MUNICIPs[[1]])

```

## Row 1 {data-height="100"}

### Espécies

```{r}

media_riqueza <- occ_NF %>% 
  dplyr::filter(species != "") %>% 
  group_by(NM_MUNICIP) %>% 
  summarise(spp = n_distinct(species)) %>% 
  mutate(media = median(spp)) %>% 
  pull() %>% 
  unique()

renderValueBox({
  riqueza <- occ_NF %>% 
    dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs) %>%
    summarise(n_distinct(species)) %>% 
    pull()
  valueBox(
    value = riqueza,
    icon = "fa-area-chart",
    color = if (riqueza < media_riqueza) "warning" else "primary"
  )
})

# https://fontawesome.com/v4/icons/

```

### Ocorrências

```{r}

media_occ <- occ_NF %>% 
  dplyr::filter(species != "") %>% 
  group_by(NM_MUNICIP) %>% 
  summarise(occ = n_distinct(occurrenceID)) %>% 
  mutate(media = median(occ)) %>% 
  pull() %>% 
  unique()

renderValueBox({
  occ_local <- occ_NF %>% 
    dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs) %>%
    summarise(n_distinct(occurrenceID)) %>% 
    pull()
  valueBox(
    value = occ_local,
    icon = "fa-area-chart",
    color = if (occ_local < media_occ) "warning" else "primary"
  )
})


```

### Ameaçadas

```{r}

media_riqueza <- occ_NF %>% 
  dplyr::filter(species != "") %>% 
  group_by(NM_MUNICIP) %>% 
  summarise(spp = n_distinct(scientificName)) %>% 
  mutate(media = mean(spp)) %>% 
  pull() %>% 
  unique()

renderValueBox({
  riqueza <- 20
  valueBox(
    value = riqueza,
    icon = "fa-area-chart",
    color = if (riqueza < media_riqueza) "warning" else "primary"
  )
})


```

## Row 2 {data-height="300"}

### Espécies por Filo e Reino

```{r}


renderPlotly({
  
  taxa <- occ_NF %>% 
  mutate(kingdom = factor(kingdom, levels = c("Viruses", "Bacteria", "Chromista", "Fungi", "Plantae", "Animalia", "incertae sedis"))) %>% 
      dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs,
                    kingdom != "incertae sedis",
                    !phylum %in% c(NA, "")) %>% 
      group_by(kingdom, phylum) %>%
      summarise(spp = n_distinct(scientificName))
 
  L2 <- taxa %>% 
  ggplot(aes(y = phylum, x = spp, fill = kingdom)) +
    geom_bar(stat = 'identity') +
    theme_classic() +
    theme(legend.position = "") +
    labs(x = "Número de espécies", y = "")
   
      ggplotly(L2)

  
})


```

### Grupos taxonômicos

```{r chart B}

renderTable({
  occ_NF %>% 
    dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs,
                  species != "") %>%
    dplyr::select(species, kingdom:order, occurrenceID) %>% 
    group_by(species, kingdom, class, order) %>% 
    summarise(ocorrencias = n_distinct(occurrenceID))

})


```

## Row 3 {data-height="300"}

### Temporal

```{r}

renderPlotly({
  
    linhas <- occ_NF %>% 
      dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs,
                    !is.na(year)) %>% 
      group_by(year) %>%
      summarise(id = n_distinct(occurrenceID),
                spp = n_distinct(species)) %>% 
      mutate(spp_cum = cumsum(spp)) 
     
   L1 <- linhas %>% 
    ggplot(aes(y = id, x = year)) +
      geom_area(fill = "blue", alpha = 0.6) +
      geom_area(data = linhas, aes(y = spp), fill = "red", alpha = 0.6) +
      theme_classic() +
      theme(legend.position = "") +
      labs(x = "Anos", y = "Espécies registradas (n)") +
      scale_x_continuous(breaks = seq(1800, 2022, by = 20))
   
   ggplotly(L1)
   
})


```

### Ocorrências no município

```{r chart C}

# conferir no mapa

renderLeaflet({
  
#UCs %>%
  leaflet() %>% 
    addTiles() %>% 
    #addPolygons() %>% 
    addCircleMarkers(data = occ_NF %>% 
                       dplyr::filter(NM_MUNICIP == input$NM_MUNICIPs,
                                     !is.na(decimalLatitude)) %>% 
                       distinct(),
                     ~decimalLongitude, 
                     ~decimalLatitude,
                     radius = 5,
                     #label = ~as.character(datasetName),
                     color = ~pal(occ_NF$kingdom),
                     stroke = FALSE, 
                     fillOpacity = 0.5) 
})


```
